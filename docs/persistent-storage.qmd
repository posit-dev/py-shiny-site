---
title: Persistent storage & writing data
editor:
  markdown:
    wrap: sentence
lightbox:
  effect: fade
---

## Intro
* Callout connect cloud and support for secrets and persistent storage, link to docs, tehre's a talk that aleks chisolm did at conf
## When do you actually need persistent storage
* You want your application to collect and save information from your users. Example, forms.
* You need to save a result that your users generate? (ex. save a copy of report generated)

Note: What are we not talking about here: Auth. Link to any auth docs we have.

CALLOUT: Connect does both Auth and supports secrets for storage. Link to those docs.

### Example with pins and polars? (use a form, save the result)

Callout: Potential concerns with lots of parallel users or nonblocking setting, then think about switching to a database

# Example 1
Pins + google drive folder

Callout, pins does this other stuff, plus has some reactive support

# Example 2
Polars and postgres, callout with vanilla SQL

```python
from shiny import App, Inputs, Outputs, Session, ui, reactive, render
import pandas as pd

# Do this dashboard style with a side bar you have user inputs with an output they change
# Submit, it gets appended to the data store and you see that in the app

# track if we're in a dirty db state, append row df as whole table append, reactive poll to get data if it's updated

app_ui = ui.page_fluid(
    ui.h2("Submitted Results"),
    ui.output_data_frame("results_df"),
    ui.input_text("text", "Enter text", value=""),
    ui.input_checkbox("checkbox", "I like checkboxes"),
    ui.input_slider("slider", "My favorite number is:", min=0, max=100, value=50),
    ui.input_action_button("submit", "Submit"),
)


def server(input: Inputs, output: Outputs, session: Session):

    df = reactive.value(pd.DataFrame(columns=["text", "checkbox", "slider"]))

    @reactive.effect
    @reactive.event(input.submit)
    def results():
        row = {
            "text": input.text(),
            "checkbox": input.checkbox(),
            "slider": input.slider(),
        }
        row_df = pd.DataFrame([row])
        new_df = pd.concat([df.get(), row_df], ignore_index=True)
        df.set(new_df)

    @render.data_frame
    def results_df():
        return render.DataGrid(df.get())


app = App(app_ui, server)
```


### Example with DuckDB (use a form, save the result)

#### DuckDB
```python
from shiny import App, Inputs, Outputs, Session, ui, reactive, render
import duckdb

con = duckdb.connect("test_db.db")

app_ui = ui.page_fluid(
    ui.h2("Submitted Results"),
    ui.output_data_frame("results_df"),
    ui.input_text("text", "Enter text", value=""),
    ui.input_checkbox("checkbox", "I like checkboxes"),
    ui.input_slider("slider", "My favorite number is:", min=0, max=100, value=50),
    ui.input_action_button("submit", "Submit"),
)

def server(input: Inputs, output: Outputs, session: Session):
    # Initialize a reactive value so we start with the table visible.
    df = reactive.value(con.sql("SELECT * FROM data").df())

    @reactive.effect
    @reactive.event(input.submit)
    def save():
        row = [input.text(), input.checkbox(), input.slider()]

        # We use a prepared statement here to avoid SQL injection
        con.execute("INSERT INTO data VALUES (?, ?, ?)", row)
        con.commit()

        # Set the reactive value so the table updates
        df.set(con.sql("SELECT * FROM data").df())

    @render.data_frame
    def results_df():
        return df()


app = App(app_ui, server, debug=True)
```

## Connecting to databases

### Example connecting with Ibis and saving to db with a form

## Deployment options

### Auth - connect callout

### SQL injection prevention
Callout near wherever we first execute SQL, be careful, diff libraries have tooling


### Connection pooling & transaction locking?

### Note on credentials? (don't use your admin creds in your app, have user creds for db, scope them narrowly, etc.)



### Example Applications
::: {.panel-tabset .panel-pills}

#### Polars


#### DuckDB
Outliers app: Reads and writes from DuckDB https://github.com/skaltman/outliers-app-db-python/blob/main/app.py
Database Explorer: https://shiny.posit.co/py/templates/database-explorer/

#### Pandas
AWS-Community-Builders-App: Process data from a CSV and displays it https://github.com/robertgv/aws-community-builders-dashboard

#### Sqlite3
Database monitoring app: https://github.com/posit-dev/py-shiny-templates/tree/main/monitor-database




